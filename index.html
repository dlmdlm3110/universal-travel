<!DOCTYPE html>
<!-- saved from url=(0032)https://rcxywnvw.genspark.space/ -->
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バリアフリー旅プランナー (Gemini API改良版)</title>
    <link href="./index_files/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./index_files/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold text-indigo-700">バリアフリー旅プランナー</h1>
            <p class="text-lg text-gray-600">車椅子ユーザーを含む家族のための旅行計画支援アプリ</p>
        </header>

        <div class="flex flex-col md:flex-row gap-6">
            <!-- 入力フォーム -->
            <div class="bg-white rounded-lg shadow-md p-6 md:w-1/2">
                <h2 class="text-xl font-bold mb-4 text-indigo-600">旅行条件を入力</h2>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">
                        Google Gemini API キー <span class="text-red-500">*</span>
                        <span class="inline-block ml-1 text-sm text-gray-500 cursor-pointer" id="apiKeyInfo" title="APIキーについて">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </label>
                    <div class="relative">
                        <input type="password" id="apiKey" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required="">
                        <button id="toggleApiKey" class="absolute inset-y-0 right-0 px-3 flex items-center">
                            <i class="fas fa-eye text-gray-500"></i>
                        </button>
                    </div>
                    <div class="mt-1 flex items-center">
                        <input type="checkbox" id="saveApiKey" class="mr-2">
                        <label for="saveApiKey" class="text-sm text-gray-600">APIキーを保存する</label>
                    </div>
                    <div class="mt-2">
                        <a href="https://ai.google.dev/" target="_blank" class="text-sm text-indigo-600 hover:underline flex items-center">
                            <span>Google AI Studioでキーを取得</span>
                            <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                        </a>
                        <p class="text-xs text-gray-500 mt-1">毎月の無料枠内で利用できます</p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">出発地 <span class="text-red-500">*</span></label>
                    <input type="text" id="departure" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required="">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">目的地 <span class="text-red-500">*</span></label>
                    <input type="text" id="destination" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required="">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">旅行日数 <span class="text-red-500">*</span></label>
                    <input type="number" id="tripDays" min="1" max="14" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required="">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">旅行メンバー</label>
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="hasWheelchair" class="mr-2" checked="">
                        <label for="hasWheelchair" class="text-gray-700">車椅子ユーザーがいる</label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">大人</label>
                            <input type="number" id="adultCount" min="1" max="10" value="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">子供</label>
                            <input type="number" id="childCount" min="0" max="10" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">希望する観光タイプ</label>
                    <select id="tourismType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="自然・景観">自然・景観</option>
                        <option value="歴史・文化">歴史・文化</option>
                        <option value="テーマパーク・アミューズメント">テーマパーク・アミューズメント</option>
                        <option value="ショッピング・グルメ">ショッピング・グルメ</option>
                        <option value="温泉・リラクゼーション">温泉・リラクゼーション</option>
                        <option value="複合（バランス良く）">複合（バランス良く）</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">宿泊施設の希望</label>
                    <textarea id="accommodation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="2" placeholder="例: バリアフリールームがある、温泉付きなど"></textarea>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">食事の希望</label>
                    <textarea id="mealPreference" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="2" placeholder="例: 地元の名物料理、車椅子でも入りやすいお店など"></textarea>
                </div>
                
                <button id="generatePlanBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 flex justify-center items-center">
                    <span>旅行プラン生成</span>
                    <i class="fas fa-paper-plane ml-2"></i>
                </button>
            </div>
            
            <!-- 結果表示エリア -->
            <div class="bg-white rounded-lg shadow-md p-6 md:w-1/2">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-indigo-600">生成された旅行プラン</h2>
                    <div class="flex gap-2">
                        <button id="copyPlanBtn" class="text-gray-500 hover:text-gray-700" title="プランをコピー">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button id="downloadPlanBtn" class="text-gray-500 hover:text-gray-700" title="プランをダウンロード">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                
                <div id="loadingIndicator" class="flex-col items-center justify-center py-10 hidden">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mb-4"></div>
                    <p class="text-gray-600">プランを生成中です。しばらくお待ちください...</p>
                </div>
                
                <div id="errorMessage" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-circle mt-1"></i>
                        </div>
                        <div class="ml-3">
                            <p id="errorText"></p>
                        </div>
                    </div>
                </div>
                
                <div id="resultContainer" class="prose max-w-none"><p class="my-3"></p><h3 class="text-xl font-bold text-indigo-600 mt-4 mb-2">神戸3日間バリアフリー旅行プラン（自然・景観重視）</h3><p class="my-3">**旅行メンバー:** 大人2名（車椅子ユーザー1名を含む）
**出発地:** 東京
**目的地:** 神戸</p><p class="my-3">
**宿泊施設:** ホテルモントレ神戸（例）</p><p class="my-3"></p><ul class="list-disc ml-5 my-3"><ol class="list-decimal ml-5 my-3"><li class="ml-4">アクセス: JR神戸駅より徒歩約5分。駅からのアクセスは比較的平坦で、車椅子でも移動しやすいです。</li><li class="ml-4">バリアフリー情報: 車椅子対応の客室あり、エレベーター完備（広々とした設計）、多目的トイレあり、スタッフによるサポート体制あり。車椅子での移動もスムーズです。事前に連絡することで、より詳細なサポートを受けられます。</li></ol></ul><p class="my-3">
**1日目：東京から神戸へ、そして六甲山へ**</p><p class="my-3"></p><ul class="list-disc ml-5 my-3"><ol class="list-decimal ml-5 my-3"><li class="ml-4">**午前8:00:** 東京駅より新幹線「のぞみ」で新神戸駅へ（約2時間30分）。新神戸駅はバリアフリー対応が充実しており、エレベーターやエスカレーターが豊富です。車椅子対応のトイレも複数箇所あります。</li><li class="ml-4">**午前10:30:** 新神戸駅到着後、六甲山へは六甲ケーブルカーを利用します。六甲ケーブルカー下駅は、スロープとエレベーターでバリアフリー対応されています。ケーブルカー車内も車椅子での乗車が可能です（事前に確認推奨）。</li><li class="ml-4">**午前11:30:** 六甲山上到着。六甲山上は、一部勾配のある遊歩道もありますが、主要な観光スポットはバリアフリー対応が比較的整っています。六甲ガーデンテラスは、平坦な通路が多く、車椅子での移動も容易です。</li><li class="ml-4">**午後12:30:** 六甲ガーデンテラス内のレストランで昼食。景色を眺めながら食事を楽しめます。バリアフリー対応のトイレも確認済みです。</li><li class="ml-4">**午後2:00:** 六甲山上の散策。六甲枝垂れ桜（時期により）や展望台など、車椅子でもアクセス可能なスポットを巡ります。スタッフに相談すれば、ルートのアドバイスも受けられます。</li><li class="ml-4">**午後4:00:** 六甲ケーブルカーで下山。</li><li class="ml-4">**午後5:00:** 新神戸駅からホテルモントレ神戸へ移動。</li><li class="ml-4">**午後6:00:** ホテルにてチェックイン。</li><li class="ml-4">**午後7:00:** ホテル内のレストランまたは近隣のバリアフリー対応レストランで夕食。</li></ol></ul><p class="my-3">
**2日目：神戸港とメリケンパーク、異人館街散策**</p><p class="my-3"></p><ul class="list-disc ml-5 my-3"><ol class="list-decimal ml-5 my-3"><li class="ml-4">**午前9:00:** ホテルで朝食。</li><li class="ml-4">**午前10:00:** ホテルから神戸ポートターミナルへ。ポートライナーを利用（バリアフリー対応）。</li><li class="ml-4">**午前10:30:** 神戸ポートターミナル到着後、メリケンパークを散策。比較的平坦な遊歩道が多く、車椅子での移動に適しています。神戸港の景色を楽しめます。バリアフリートイレはポートターミナル内にあります。</li><li class="ml-4">**午後12:00:** メリケンパーク内のレストランで昼食。</li><li class="ml-4">**午後1:30:**  異人館街へ移動。異人館街は坂道が多いですが、一部の建物はバリアフリー対応がされています。事前に確認し、アクセス可能な建物を選びましょう。車椅子の通行が難しい箇所もありますので、事前にルートを確認することをお勧めします。</li><li class="ml-4">**午後3:30:**  異人館街散策後、元町商店街へ。比較的平坦な道で、車椅子での移動も容易です。</li><li class="ml-4">**午後5:00:**  元町商店街で買い物や休憩。</li><li class="ml-4">**午後6:00:**  夕食は元町商店街内のレストランまたはホテルで。</li></ol></ul><p class="my-3">
**3日目：須磨離宮公園と帰京**</p><p class="my-3"></p><ul class="list-disc ml-5 my-3"><ol class="list-decimal ml-5 my-3"><li class="ml-4">**午前9:00:** ホテルで朝食。</li><li class="ml-4">**午前10:00:**  ホテルから須磨離宮公園へ。JR神戸線で須磨駅まで行き、駅から公園まではタクシーを利用（事前にバリアフリー対応のタクシー会社に予約することをお勧めします）。公園内は一部段差がありますが、主要なエリアは車椅子でもアクセス可能です。事前に公園に問い合わせて、車椅子での移動について相談することをお勧めします。</li><li class="ml-4">**午前11:00:** 須磨離宮公園散策。美しい庭園と海辺の景色を楽しめます。</li><li class="ml-4">**午後1:00:** 公園内のレストランまたは近くのレストランで昼食。</li><li class="ml-4">**午後2:30:** 須磨駅から新神戸駅へ移動。</li><li class="ml-4">**午後3:00:** 新神戸駅から新幹線「のぞみ」で東京駅へ（約2時間30分）。</li><li class="ml-4">**午後5:30:** 東京駅到着。</li></ol></ul><p class="my-3">
**注意:**</p><p class="my-3"></p><ul class="list-disc ml-5 my-3"><ol class="list-decimal ml-5 my-3"><li class="ml-4">上記プランはあくまで提案であり、天候や体調によって変更される可能性があります。</li><li class="ml-4">各施設のバリアフリー情報は事前に公式ウェブサイトなどで確認することをお勧めします。</li><li class="ml-4">車椅子利用者にとって快適な旅行となるよう、事前に各施設に問い合わせて、サポート体制やアクセスの詳細を確認することを強く推奨します。</li><li class="ml-4">移動手段は状況に応じて、タクシーやバスなども考慮してください。</li></ol></ul><p class="my-3">
このプランが、快適で思い出に残る神戸旅行の計画に役立つことを願っています。  事前に各施設に連絡を取り、最新の情報を確認することを忘れないでください。
</p></div>
            </div>
        </div>
        
        <!-- APIキー情報モーダル -->
        <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Gemini APIキーについて</h3>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="text-gray-600">
                    <p class="mb-3">Google AI StudioからGemini APIキーを取得して利用できます。</p>
                    <p class="mb-3">取得手順:</p>
                    <ol class="list-decimal pl-5 mb-4 space-y-1">
                        <li><a href="https://ai.google.dev/" target="_blank" class="text-indigo-600 hover:underline">Google AI Studio</a>にアクセス</li>
                        <li>Googleアカウントでログイン</li>
                        <li>「Get API key」をクリック</li>
                        <li>新しいAPIキーを作成またはプロジェクトを選択</li>
                        <li>生成されたAPIキーをコピー</li>
                    </ol>
                    <p class="mb-2">注意事項:</p>
                    <ul class="list-disc pl-5 mb-4 space-y-1">
                        <li>APIキーは個人情報と同様に慎重に扱ってください</li>
                        <li>共有PCでの保存は避けてください</li>
                        <li>毎月の無料枠を超えると料金が発生する場合があります</li>
                    </ul>
                    <p class="text-xs text-gray-500">※このアプリではAPIキーは使用される端末内のみに保存され、サーバーに送信されることはありません</p>
                </div>
                <button id="okButton" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md w-full">了解しました</button>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white text-center py-4 mt-10">
        <p>© 2024 バリアフリー旅プランナー | 車椅子ユーザーを含む家族のための旅行計画支援</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM要素
            const apiKeyInput = document.getElementById('apiKey');
            const saveApiKeyCheckbox = document.getElementById('saveApiKey');
            const toggleApiKeyBtn = document.getElementById('toggleApiKey');
            const departureInput = document.getElementById('departure');
            const destinationInput = document.getElementById('destination');
            const tripDaysInput = document.getElementById('tripDays');
            const hasWheelchairCheckbox = document.getElementById('hasWheelchair');
            const adultCountInput = document.getElementById('adultCount');
            const childCountInput = document.getElementById('childCount');
            const tourismTypeSelect = document.getElementById('tourismType');
            const accommodationInput = document.getElementById('accommodation');
            const mealPreferenceInput = document.getElementById('mealPreference');
            const generatePlanBtn = document.getElementById('generatePlanBtn');
            const resultContainer = document.getElementById('resultContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const copyPlanBtn = document.getElementById('copyPlanBtn');
            const downloadPlanBtn = document.getElementById('downloadPlanBtn');
            const apiKeyInfo = document.getElementById('apiKeyInfo');
            const apiKeyModal = document.getElementById('apiKeyModal');
            const closeModal = document.getElementById('closeModal');
            const okButton = document.getElementById('okButton');
            
            // ローカルストレージからデータを復元
            function loadFromLocalStorage() {
                if (localStorage.getItem('bf_travel_planner_api_key')) {
                    apiKeyInput.value = localStorage.getItem('bf_travel_planner_api_key');
                    saveApiKeyCheckbox.checked = true;
                }
                
                if (localStorage.getItem('bf_travel_planner_departure')) {
                    departureInput.value = localStorage.getItem('bf_travel_planner_departure');
                }
                
                if (localStorage.getItem('bf_travel_planner_destination')) {
                    destinationInput.value = localStorage.getItem('bf_travel_planner_destination');
                }
                
                if (localStorage.getItem('bf_travel_planner_trip_days')) {
                    tripDaysInput.value = localStorage.getItem('bf_travel_planner_trip_days');
                }
                
                if (localStorage.getItem('bf_travel_planner_has_wheelchair') !== null) {
                    hasWheelchairCheckbox.checked = localStorage.getItem('bf_travel_planner_has_wheelchair') === 'true';
                }
                
                if (localStorage.getItem('bf_travel_planner_adult_count')) {
                    adultCountInput.value = localStorage.getItem('bf_travel_planner_adult_count');
                }
                
                if (localStorage.getItem('bf_travel_planner_child_count')) {
                    childCountInput.value = localStorage.getItem('bf_travel_planner_child_count');
                }
                
                if (localStorage.getItem('bf_travel_planner_tourism_type')) {
                    tourismTypeSelect.value = localStorage.getItem('bf_travel_planner_tourism_type');
                }
                
                if (localStorage.getItem('bf_travel_planner_accommodation')) {
                    accommodationInput.value = localStorage.getItem('bf_travel_planner_accommodation');
                }
                
                if (localStorage.getItem('bf_travel_planner_meal_preference')) {
                    mealPreferenceInput.value = localStorage.getItem('bf_travel_planner_meal_preference');
                }
                
                // 以前生成したプランを表示
                if (localStorage.getItem('bf_travel_planner_last_plan')) {
                    resultContainer.innerHTML = localStorage.getItem('bf_travel_planner_last_plan');
                }
            }
            
            // ローカルストレージにデータを保存
            function saveToLocalStorage() {
                // APIキーは保存オプションがチェックされている場合のみ保存
                if (saveApiKeyCheckbox.checked) {
                    localStorage.setItem('bf_travel_planner_api_key', apiKeyInput.value);
                } else {
                    localStorage.removeItem('bf_travel_planner_api_key');
                }
                
                // その他のフォーム入力は常に保存
                localStorage.setItem('bf_travel_planner_departure', departureInput.value);
                localStorage.setItem('bf_travel_planner_destination', destinationInput.value);
                localStorage.setItem('bf_travel_planner_trip_days', tripDaysInput.value);
                localStorage.setItem('bf_travel_planner_has_wheelchair', hasWheelchairCheckbox.checked);
                localStorage.setItem('bf_travel_planner_adult_count', adultCountInput.value);
                localStorage.setItem('bf_travel_planner_child_count', childCountInput.value);
                localStorage.setItem('bf_travel_planner_tourism_type', tourismTypeSelect.value);
                localStorage.setItem('bf_travel_planner_accommodation', accommodationInput.value);
                localStorage.setItem('bf_travel_planner_meal_preference', mealPreferenceInput.value);
            }
            
            // APIキー表示/非表示の切り替え
            toggleApiKeyBtn.addEventListener('click', function() {
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    toggleApiKeyBtn.innerHTML = '<i class="fas fa-eye-slash text-gray-500"></i>';
                } else {
                    apiKeyInput.type = 'password';
                    toggleApiKeyBtn.innerHTML = '<i class="fas fa-eye text-gray-500"></i>';
                }
            });
            
            // APIキー情報モーダルの表示
            apiKeyInfo.addEventListener('click', function() {
                apiKeyModal.classList.remove('hidden');
            });
            
            // モーダルを閉じる
            closeModal.addEventListener('click', function() {
                apiKeyModal.classList.add('hidden');
            });
            
            okButton.addEventListener('click', function() {
                apiKeyModal.classList.add('hidden');
            });
            
            // モーダル外クリックで閉じる
            apiKeyModal.addEventListener('click', function(e) {
                if (e.target === apiKeyModal) {
                    apiKeyModal.classList.add('hidden');
                }
            });
            
            // Gemini APIを使用して旅行プランを生成
            async function generateTravelPlan() {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    showError('APIキーを入力してください');
                    return;
                }
                
                const departure = departureInput.value.trim();
                if (!departure) {
                    showError('出発地を入力してください');
                    return;
                }
                
                const destination = destinationInput.value.trim();
                if (!destination) {
                    showError('目的地を入力してください');
                    return;
                }
                
                const tripDays = tripDaysInput.value;
                if (!tripDays || tripDays < 1) {
                    showError('有効な旅行日数を入力してください');
                    return;
                }
                
                // 入力データを保存
                saveToLocalStorage();
                
                // UI更新
                resultContainer.innerHTML = '';
                loadingIndicator.classList.remove('hidden');
                loadingIndicator.classList.add('flex');
                errorMessage.classList.add('hidden');
                generatePlanBtn.disabled = true;
                
                // プロンプト構築
                const hasWheelchair = hasWheelchairCheckbox.checked;
                const adultCount = adultCountInput.value || 1;
                const childCount = childCountInput.value || 0;
                const tourismType = tourismTypeSelect.value;
                const accommodation = accommodationInput.value;
                const mealPreference = mealPreferenceInput.value;
                
                let memberInfo = `大人${adultCount}名`;
                if (childCount > 0) {
                    memberInfo += `、子供${childCount}名`;
                }
                
                let prompt = `以下の条件に合わせた詳細な旅行プランを作成してください。日程ごとに分けて、バリアフリー対応の情報を含めて詳しく説明してください：

出発地: ${departure}
目的地: ${destination}
旅行日数: ${tripDays}日間
旅行メンバー: ${memberInfo}
${hasWheelchair ? '※車椅子ユーザーを含みます' : ''}
観光の種類: ${tourismType}
${accommodation ? '宿泊施設の希望: ' + accommodation : ''}
${mealPreference ? '食事の希望: ' + mealPreference : ''}

${hasWheelchair ? '【重要】車椅子ユーザーのための配慮として、以下のバリアフリー情報を各スポットについて必ず含めてください：\n- 入り口のスロープや段差の有無\n- エレベーターの有無と広さ\n- 多目的トイレ・バリアフリートイレの設置場所\n- 車椅子での移動のしやすさ\n- スタッフによるサポート体制\n- アクセシブルな交通手段' : ''}

必ず日付ごとに見出しを付け、移動時間やアクセス方法、食事場所の推薦も含めてください。移動経路や所要時間の目安も示してください。宿泊施設についても詳しく説明してください。`;

                try {
                    // Google Gemini API呼び出し - 最新の仕様に基づいたエンドポイントとパラメータ
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 4096,
                                topP: 0.95,
                                topK: 40
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        let errorMsg = 'APIリクエストに失敗しました';
                        if (data && data.error) {
                            errorMsg += `: ${data.error.message}`;
                        }
                        throw new Error(errorMsg);
                    }
                    
                    // 応答がない場合のエラー処理
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                        throw new Error('APIからの応答が不正な形式です');
                    }
                    
                    // テキスト応答を取得し表示
                    const generatedText = data.candidates[0].content.parts[0].text;
                    const formattedResult = formatResult(generatedText);
                    resultContainer.innerHTML = formattedResult;
                    
                    // 生成結果をローカルストレージに保存
                    localStorage.setItem('bf_travel_planner_last_plan', formattedResult);
                    
                } catch (error) {
                    console.error('Error:', error);
                    showError(error.message || 'プランの生成中にエラーが発生しました');
                } finally {
                    loadingIndicator.classList.add('hidden');
                    loadingIndicator.classList.remove('flex');
                    generatePlanBtn.disabled = false;
                }
            }
            
            // Markdown風のテキストを整形してHTML表示
            function formatResult(text) {
                if (!text) return '';
                
                // 日付見出しの強調
                text = text.replace(/^(第\d+日|1日目|2日目|3日目|4日目|5日目|6日目|7日目|【.*?】)/gm, '<h3 class="text-xl font-bold text-indigo-700 mt-6 mb-3">$1</h3>');
                
                // 見出しの強調
                text = text.replace(/^(#\s+)(.*?)$/gm, '<h2 class="text-2xl font-bold text-indigo-700 mt-6 mb-3">$2</h2>');
                text = text.replace(/^(##\s+)(.*?)$/gm, '<h3 class="text-xl font-bold text-indigo-600 mt-4 mb-2">$2</h3>');
                
                // バリアフリー情報のハイライト
                text = text.replace(/【バリアフリー情報】(.*?)(?=\n\n|\n$|$)/gs, '<div class="bg-blue-50 border-l-4 border-blue-500 p-3 my-3"><strong class="text-blue-700">【バリアフリー情報】</strong>$1</div>');
                
                // 重要なポイントのハイライト
                text = text.replace(/【(.*?)】/g, '<span class="font-bold text-indigo-600">【$1】</span>');
                
                // 箇条書きの処理
                text = text.replace(/^[-*]\s+(.*?)$/gm, '<li class="ml-4">$1</li>');
                text = text.replace(/<\/li>\n<li/g, '</li><li');
                text = text.replace(/(<li.*?>)(.*?)(<\/li>)/g, function(match, p1, p2, p3) {
                    if (/<li/.test(p2)) return match;
                    return p1 + p2 + p3;
                });
                text = text.replace(/(<li.*?>.*?<\/li>)+/g, '<ul class="list-disc ml-5 my-3">$&</ul>');
                
                // 番号付きリストの処理
                text = text.replace(/^\d+\.\s+(.*?)$/gm, '<li class="ml-4">$1</li>');
                text = text.replace(/(<li.*?>.*?<\/li>)+/g, function(match) {
                    if (match.indexOf('list-disc') >= 0) return match;
                    return '<ol class="list-decimal ml-5 my-3">' + match + '</ol>';
                });
                
                // 段落の処理
                text = text.replace(/\n\n/g, '</p><p class="my-3">');
                text = '<p class="my-3">' + text + '</p>';
                text = text.replace(/<p>\s*<\/p>/g, '');
                text = text.replace(/<p>\s*<(h|ul|ol|div)/g, '<$1');
                text = text.replace(/(<\/h[1-6]>|<\/ul>|<\/ol>|<\/div>)\s*<\/p>/g, '$1');
                
                return text;
            }
            
            // エラーメッセージの表示
            function showError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
                window.scrollTo({ top: errorMessage.offsetTop - 100, behavior: 'smooth' });
            }
            
            // プランをクリップボードにコピー
            copyPlanBtn.addEventListener('click', function() {
                if (resultContainer.textContent.trim() === '旅行プランが表示されます' || resultContainer.innerHTML.includes('こちらに旅行プランが表示されます')) {
                    return;
                }
                
                // HTML要素から平文テキストを取得
                const tempElement = document.createElement('div');
                tempElement.innerHTML = resultContainer.innerHTML;
                const textToCopy = tempElement.textContent;
                
                navigator.clipboard.writeText(textToCopy).then(function() {
                    const originalHTML = copyPlanBtn.innerHTML;
                    copyPlanBtn.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                    setTimeout(function() {
                        copyPlanBtn.innerHTML = originalHTML;
                    }, 2000);
                });
            });
            
            // プランをテキストファイルとしてダウンロード
            downloadPlanBtn.addEventListener('click', function() {
                if (resultContainer.textContent.trim() === '旅行プランが表示されます' || resultContainer.innerHTML.includes('こちらに旅行プランが表示されます')) {
                    return;
                }
                
                // HTML要素から平文テキストを取得
                const tempElement = document.createElement('div');
                tempElement.innerHTML = resultContainer.innerHTML;
                const textToDownload = tempElement.textContent;
                
                const departure = departureInput.value || '出発地';
                const destination = destinationInput.value || '目的地';
                const date = new Date().toISOString().slice(0, 10);
                const filename = `バリアフリー旅プラン_${departure}から${destination}_${date}.txt`;
                
                const blob = new Blob([textToDownload], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            });
            
            // プラン生成ボタンのクリックイベント
            generatePlanBtn.addEventListener('click', generateTravelPlan);
            
            // 初期化: ローカルストレージからデータを読み込む
            loadFromLocalStorage();
        });
    </script>


    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDk89f0lIXj34HfSI2EN0PmVrWU%2F8KEHzMFQK2OmfqGt17hflrm9kbeoIOPHqDhzaj5srFSFy40PAGYSG%2FJMyavTu8TuJzNuwXXO6%2FFEkkI%2FJkJSc8mrkSBFHxA4BxAx6qFekvZZm6EXCW306vK74kc5tegxnsWFxdX%2BrgGP94BNfvEAXwL1v5FmaUSQ4pm9mXOqqmzcn3e0k0rxU0C6yECQoGZOterN9oGnsfi3Egl8fEdJ1Kky%2Bu2vxWlBk1ou2phuBjQ4ZOa5sZPQy9Ja%2FZ5YwvZ9GJ3C3eiBLlDYs52VaefgSHFhRLs8nlI2veFyC8S79Sopiuo0PZSJVI4YFYDiiravB8Bvzxe6lMcZXdRBASOx0ifFMzjTrYZRQ3OX%2FGC3FZdfW6CCveRvHTL9aLyG2iszQ71FkfV5h0SQx6hwBEIPuTVi1wpH75leIUo7GRJz3%2BP22TqM12hamhgyx9Q%2BakUQMG4w00rwvQXnqXfWlnYLYi3aHI2FQYrPN2BCEeEh6QUIenHVlL2D%2BcGS86Q4%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDk89f0lIXj34HfSI2EN0PmVrWU/8KEHzMFQK2OmfqGt17hflrm9kbeoIOPHqDhzaj5srFSFy40PAGYSG/JMyavTu8TuJzNuwXXO6/FEkkI/JkJSc8mrkSBFHxA4BxAx6qFekvZZm6EXCW306vK74kc5tegxnsWFxdX+rgGP94BNfvEAXwL1v5FmaUSQ4pm9mXOqqmzcn3e0k0rxU0C6yECQoGZOterN9oGnsfi3Egl8fEdJ1Kky+u2vxWlBk1ou2phuBjQ4ZOa5sZPQy9Ja/Z5YwvZ9GJ3C3eiBLlDYs52VaefgSHFhRLs8nlI2veFyC8S79Sopiuo0PZSJVI4YFYDiiravB8Bvzxe6lMcZXdRBASOx0ifFMzjTrYZRQ3OX/GC3FZdfW6CCveRvHTL9aLyG2iszQ71FkfV5h0SQx6hwBEIPuTVi1wpH75leIUo7GRJz3+P22TqM12hamhgyx9Q+akUQMG4w00rwvQXnqXfWlnYLYi3aHI2FQYrPN2BCEeEh6QUIenHVlL2D+cGS86Q4=";
    </script>
    </body></html>